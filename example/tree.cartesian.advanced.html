<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Cartesian Tree Example</title>
    <script src="../bower_components/d3/d3.min.js"></script>
    <script src="../bower_components/d3.chart/d3.chart.min.js"></script>
    <script src="../bower_components/jquery/dist/jquery.min.js"></script>
    <script src="../bower_components/json-editor/dist/jsoneditor.min.js"></script>
    <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

    <script src="../d3.chart.layout.hierarchy.js"></script>

    <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/tree.cartesian.css">
  </head>
  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">d3.chart.layout.hierarchy</a>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-3 col-md-2 sidebar">
          <div id="editor_holder" class="prop-edit"></div>
          <div>
            <button id="create_random_tree" class="btn btn-default">Create random tree</button>
          </div>
        </div>

        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
          <h1 class="page-header">tree.cartesian</h1>

          <div id="vis"></div>
        </div>
      </div>
    </div>



  <div class="content">




    </div>

    <script>
      (function() {

        var tree;

        var options = {
          levelGap: "auto",
          collapsible: 1
        };


        function drawTree(options, json) {
          $("#vis").empty();

          var tree = d3.select("#vis").append("svg")

            .chart("tree.cartesian")
            .margin({ top: 0, right: 180, bottom: 0, left: 40 })
            .radius(function(d) { if( d.size ) return Math.log(d.size); else return 7; })
            .sort(function(a, b) { return d3.descending(a.size, b.size); })
            .zoomable([0.1, 3]);

          applyOptions(tree, options);

          tree.draw(json);

          return tree;
        }

        function applyOptions(tree, options) {
          console.log(">>> Applying options:");
          console.log(options);

          tree
            .levelGap(options.levelGap)
            .collapsible(options.collapsible == "none" ? null : parseInt(options.collapsible));
        }


        d3.json("data/flare.json", function(error, json) {

          var propSchema = {
            type: "object",
            title: "Properties",
            properties: {
              levelGap: {type: "string", enum: ["auto", 100, 200, 300]},
              collapsible: {type: "string", enum: ["none", 0, 1, 2, 3, 4, 5]}
            }
          };

          tree = drawTree(options, json);

          // Editor
          JSONEditor.defaults.options.theme = 'bootstrap3';

          // Initialize the editor
          var editor = new JSONEditor(document.getElementById("editor_holder"),{
            schema: propSchema,
            disable_properties: true,
            disable_edit_json: true,
            disable_collapse: true,
            form_name_root: "chart",
            startval: options
          });


          // Listen for changes
          editor.on("change",  function() {
            applyOptions(tree, editor.getValue());
          });
        });

        function generateRandomTree(levels, maxChildrenPerParent) {
          var root = {
            name: 'root',
            children: []
          };

          function generateChildren(currentRoot, level) {
            if (level > levels)
              return;

            var numChildren = Math.floor((Math.random() * maxChildrenPerParent) + 1);
            for(var i = 0; i < numChildren; i++) {
              var child = {
                name: "child " + level + "-" + (i + 1),
                children: []
              };

              currentRoot.children.push(child);

              generateChildren(child, level + 1);
            }
          }

          generateChildren(root, 1);

          return root;
        }


        $(function() {
          $('#create_random_tree').click(function() {
            var json = generateRandomTree(3, 5);

            //tree = drawTree(options, json);
            // TODO: tree should render new data when draw is invoked.
            tree.draw(json);
          })
        });

      })();
    </script>
  </body>
</html>
